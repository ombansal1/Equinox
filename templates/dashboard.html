<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Equinox Dashboard - {{username}}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Shared styles: aura gradients, cards, etc. -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #121212;
      color: #E0E0E0;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    header img { width: 55px; height: 55px; }
    header h1 { margin: 0; font-size: 26px; color: #40E0D0; }
    header p  { margin: 0; font-size: 14px; color: #A0A0A0; }

    .chart-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
    }
    .chart-card {
      flex: 1 1 48%;
      background: #1E1E1E;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(64, 224, 208, 0.2);
      text-align: center;
      min-width: 380px;
    }
    canvas {
      width: 100% !important;
      height: 280px !important;
      background: #121212;
      border-radius: 8px;
      padding: 5px;
    }
    /* Make the radar chart notably taller */
    #emotionRadar {
      height: 380px !important;
    }

    @media (max-width: 900px) {
      .chart-card { flex: 1 1 100%; }
      canvas { height: 260px !important; }
      #emotionRadar { height: 340px !important; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Equinox Logo">
      <div>
        <h1>Equinox</h1>
        <p>Balancing minds, one insight at a time.</p>
      </div>
    </header>

    <!-- ðŸŒˆ Aura Card -->
    <div class="aura-card">
      <div id="auraGradient" class="aura-gradient default-gradient"></div>
      <div class="aura-text">
        <h2>Your Aura</h2>
        <p id="aura-info">Loading...</p>
      </div>
    </div>

    <!-- ðŸ“ˆ Charts Grid -->
    <div class="chart-grid">
      <div class="chart-card">
        <h3>Mood Trend (Last 60 Days)</h3>
        <canvas id="moodChart"></canvas>
      </div>

      <div class="chart-card">
        <h3>Weekly Emotion Distribution</h3>
        <canvas id="emotionRadar"></canvas>
      </div>
    </div>

    <div id="alerts"></div>
  </div>

  <script>
    const username = "{{username}}";

    // Map aura label -> CSS gradient class
    function auraClassFor(label = "") {
      const t = label.toLowerCase();
      if (t.includes("calm green"))      return "calm-green";
      if (t.includes("radiant orange"))  return "radiant-orange";
      if (t.includes("tranquil blue"))   return "tranquil-blue";
      if (t.includes("stormy gray"))     return "stormy-gray";
      if (t.includes("blossom pink"))    return "blossom-pink";
      if (t.includes("bright yellow"))   return "bright-yellow";
      return "default-gradient";
    }

    // Radar visibility tuning
    const RADAR_GAMMA = 0.6;        // boost small values
    const RADAR_MULTIPLIER = 2.5;   // scale up overall size (cap to 1)

    // Fetch posts first, then aura + charts
    fetch(`/api/fetch/${username}`)
      .then(r => r.json())
      .then(fetchData => {
        if (!fetchData.ok || (fetchData.fetched ?? 0) === 0) {
          document.getElementById("aura-info").textContent =
            "No recent posts found or fetch failed.";
          return;
        }

        // --- AURA ---
        fetch(`/api/aura/${username}`)
          .then(r => r.json())
          .then(data => {
            const auraDiv = document.getElementById("aura-info");
            const grad = document.getElementById("auraGradient");
            if (!data || data.error) {
              auraDiv.textContent = "Not enough data to determine aura.";
              grad.className = "aura-gradient default-gradient";
            } else {
              auraDiv.innerHTML = `<strong>${data.aura}</strong><br>${data.description}`;
              grad.className = `aura-gradient ${auraClassFor(data.aura)}`;
            }
          });

        // --- MOOD TREND ---
        fetch(`/api/mood_trend/${username}?days=60`)
          .then(r => r.json())
          .then(data => {
            const trend = data.trend || [];
            if (!trend.length) return;

            const labels = trend.map(d => d.date);
            const values = trend.map(d => d.avg_compound);

            new Chart(document.getElementById("moodChart"), {
              type: "line",
              data: {
                labels,
                datasets: [{
                  label: "Mood Sentiment (Daily Avg)",
                  data: values,
                  fill: true,
                  borderColor: "#40E0D0",
                  backgroundColor: "rgba(64,224,208,0.15)",
                  tension: 0.25,
                  pointRadius: 3,
                  pointBackgroundColor: "#40E0D0"
                }]
              },
              options: {
                scales: {
                  y: { min: -1, max: 1, ticks: { color: "#E0E0E0" } },
                  x: { ticks: { color: "#E0E0E0" } }
                },
                plugins: { legend: { labels: { color: "#E0E0E0" } } },
                maintainAspectRatio: false
              }
            });
          });

        // --- EMOTION RADAR (gamma + multiplier) ---
        fetch(`/api/emotions/${username}`)
          .then(r => r.json())
          .then(data => {
            if (!data || Object.keys(data).length === 0) return;

            const labels = Object.keys(data);
            const raw = Object.values(data).map(v => Number(v) || 0);

            // 1) gamma boost small values
            const boosted = raw.map(v => Math.pow(v, RADAR_GAMMA));
            // 2) renormalize
            const sum = boosted.reduce((a,b)=>a+b,0) || 1;
            const norm = boosted.map(v => v / sum);
            // 3) multiply to make the shape larger, cap at 1.0
            const values = norm.map(v => Math.min(v * RADAR_MULTIPLIER, 1));

            new Chart(document.getElementById("emotionRadar"), {
              type: "radar",
              data: {
                labels,
                datasets: [{
                  label: "Weekly Emotion Intensity",
                  data: values,
                  backgroundColor: "rgba(64,224,208,0.25)",
                  borderColor: "#40E0D0",
                  borderWidth: 2,
                  pointBackgroundColor: "#40E0D0"
                }]
              },
              options: {
                scales: {
                  r: {
                    min: 0, max: 1,
                    ticks: { display: false },
                    pointLabels: { color: "#E0E0E0" },
                    grid: { color: "#333" },
                    angleLines: { color: "#444" }
                  }
                },
                plugins: { legend: { labels: { color: "#E0E0E0" } } },
                maintainAspectRatio: false
              }
            });
          });
      })
      .catch(() => {
        document.getElementById("aura-info").textContent = "Failed to load data.";
        document.getElementById("auraGradient").className = "aura-gradient default-gradient";
      });
  </script>
</body>
</html>
